# Molian API Worker
# 部署前请执行: wrangler d1 create molian-db 并替换下方 database_id（或沿用现有 DB 的 id）
# R2: wrangler r2 bucket create molian-assets
#
# 本地与线上共用同一 D1/R2：使用 npm run dev（内部为 wrangler dev --remote），
# 本地 Worker 会连接云端 D1、R2；仅需本地 D1/R2 时用 npm run dev:local。
name = "molian-api"
main = "src/index.ts"
compatibility_date = "2024-12-01"
workers_dev = true

# 自定义域名 api.molian.app：需在 Cloudflare 中把该域名加入同一账号并解析到此 Worker。
# 若域名已在 Cloudflare，可取消下面注释，部署后路由会生效。
# routes = [
#   { pattern = "api.molian.app", zone_name = "molian.app" }
# ]

[vars]
JWT_SECRET = "0123456789abcdef0123456789abcdef"

[[d1_databases]]
binding = "molian_db"
database_name = "molian-db"
database_id = "54e1d4d0-ec73-42a8-b208-fd2ffe2fe4b4"
migrations_dir = "migrations"

[[r2_buckets]]
binding = "ASSETS"
bucket_name = "molian-assets"
# 开发与生产使用同一桶（生产模式运行）
preview_bucket_name = "molian-assets"

[durable_objects]
bindings = [
  { name = "CHAT", class_name = "ChatRoom", script_name = "molian-api" }
]

[[migrations]]
tag = "v1"
new_sqlite_classes = ["ChatRoom"]
